function ejecutarconsultas(e,o){connection.query(e,(e,r,t)=>{e?o(e,null):o(null,r)})}const moment=require("moment"),Modbus=require("jsmodbus"),net=require("net"),colors=require("colors"),dotenv=require("dotenv"),mqtt=require("mqtt"),request=require("request"),http=require("http"),{log:log,Console:Console}=require("console"),{exec:exec}=require("child_process");dotenv.config();const{connection:connection}=require("./config.db");ejecutarconsultas("select*from Rasp;",(e,o)=>{if(e)console.log("Error al consultar la base de datos ");else{let e=`Cgr/${o[0].Num_OT}/${o[0].Calve_Rasp}`;const r=new net.Socket,t=new Modbus.client.TCP(r),a={host:o[0].Host_Plc,port:o[0].Port_Plc};r.connect(a),r.on("connect",e=>console.log("Conectado al PLC")),r.on("error",e=>console.log(e));const n=`ws://${o[0].Host_Mqtt}:${o[0].Port_Mqtt}/mqtt`,s=`Server_${Math.floor(1e4*Math.random()+1)}`;http.get("http://httpbin.org/ip",e=>{let o="";e.on("data",e=>{o+=e}),e.on("end",()=>{const e=JSON.parse(o).origin,r=`http://ip-api.com/json/${e}`;let t;request(r,function(o,r,a){o||200!=r.statusCode||(t=JSON.parse(a),latitude=t.lat,longitude=t.lon),ejecutarconsultas(`update Rasp set Ip_Publica='${e}',longitud='${latitude}',latitud='${longitude}' where Id='1';`,(e,o)=>{})})})}).on("error",e=>{console.log("Error: "+e.message)});const l={clientId:s,clean:!0,keepalive:5e3,protocolVersion:5,connectTimeout:1e3,reconnectPeriod:5e3},c=mqtt.connect(n,l);c.on("connect",()=>{console.log("Conectado al broker de CGR"),c.subscribe(`${e}/#`,n=>{if(n)console.log("Error al suscribir");else{let n=r.resume()._readableState.destroyed;n&&r.connect(a),ejecutarconsultas("select*from parametros order by Tipo,Nombre asc",(r,a)=>{r?console.log("Error al consultar parámetros"):(setInterval(()=>{Fecha=moment().utcOffset("-06:00").format("YYYY-MM-DD HH:mm:ss"),a.map(function(r,a){"BIT"==r.Tipo?t.readCoils(r.Addr,1).then(t=>{let a=t.response._body._valuesAsArray[0],n={fecha_hora:Fecha,id_estacion:o[0].Calve_Rasp,nombre_estacion:o[0].Nombre_Estacion,Ip_Publica:o[0].Ip_Publica,Ubicacion:{longitud:o[0].longitud,latitud:o[0].latitud},Addr:r.Addr,Nombre:r.Nombre,Tipo:r.Tipo,Valor:a,Variable:r.Variable,Descripcion:r.Descripcion,UM:r.UM};"AVISOS FALLAS"==r.Descripcion&&ejecutarconsultas(`select*from Registro_Falla where Id_Parametro='${r.Id}' order by Id desc limit 1`,(e,o)=>{e||(Object.keys(o).length>0?Number(o[0].Valor)!=Number(a)&&ejecutarconsultas(`insert into Registro_Falla(Id_Parametro,Valor,Fecha) values('${r.Id}','${a}','${Fecha}');`,(e,o)=>{}):1==a&&ejecutarconsultas(`insert into Registro_Falla(Id_Parametro,Valor,Fecha) values('${r.Id}','${a}','${Fecha}');`,(e,o)=>{}))}),c.publish(`${e}/${r.Nombre}`,JSON.stringify(n),{qos:0,retain:!1},e=>{})}).catch(function(){console.log("BIT "+require("util").inspect(arguments,{depth:null}),null)}):"FLOAT"==r.Tipo?t.readHoldingRegisters(r.Addr,2).then(t=>{let a=t.response._body._valuesAsArray,n=Buffer.allocUnsafe(4);n.writeUInt16BE(a[0],2),n.writeUInt16BE(a[1],0);let s=n.readFloatBE(0).toFixed(2),l={fecha_hora:Fecha,id_estacion:o[0].Calve_Rasp,nombre_estacion:o[0].Nombre_Estacion,Ip_Publica:o[0].Ip_Publica,Ubicacion:{longitud:o[0].longitud,latitud:o[0].latitud},Addr:r.Addr,Nombre:r.Nombre,Tipo:r.Tipo,Valor:s,Variable:r.Variable,Descripcion:r.Descripcion,UM:r.UM};c.publish(`${e}/${r.Nombre}`,JSON.stringify(l),{qos:0,retain:!1},e=>{})}).catch(function(){console.error("FLOAT "+require("util").inspect(arguments,{depth:null}))}):t.readHoldingRegisters(r.Addr,1).then(t=>{let a=t.response._body._valuesAsArray[0],n={fecha_hora:Fecha,id_estacion:o[0].Calve_Rasp,nombre_estacion:o[0].Nombre_Estacion,Ip_Publica:o[0].Ip_Publica,Ubicacion:{longitud:o[0].longitud,latitud:o[0].latitud},Addr:r.Addr,Nombre:r.Nombre,Tipo:r.Tipo,Valor:a,Variable:r.Variable,Descripcion:r.Descripcion,UM:r.UM};c.publish(`${e}/${r.Nombre}`,JSON.stringify(n)+"",{qos:0,retain:!1},e=>{})}).catch(function(){console.error("INT "+require("util").inspect(arguments,{depth:null}))})})},o[0].Mqtt_Time),setInterval(()=>{Fecha=moment().utcOffset("-06:00").format("YYYY-MM-DD HH:mm:ss"),a.map(function(e,o){"BIT"==e.Tipo?t.readCoils(e.Addr,1).then(o=>{let r=o.response._body._valuesAsArray[0];ejecutarconsultas(`insert into historial(Id_Parametro,Valor,Fecha) values('${e.Id}','${r}','${Fecha}');`,(e,o)=>{})}).catch(function(){console.log("BIT "+require("util").inspect(arguments,{depth:null}),null)}):"FLOAT"==e.Tipo?t.readCoils(e.Addr,2).then(o=>{let r=o.response._body._valuesAsArray,t=Buffer.allocUnsafe(4);t.writeUInt16BE(r[0],2),t.writeUInt16BE(r[1],0);let a=t.readFloatBE(0);ejecutarconsultas(`insert into historial(Id_Parametro,Valor,Fecha) values('${e.Id}','${a}','${Fecha}');`,(e,o)=>{})}).catch(function(){console.error("FLOAT "+require("util").inspect(arguments,{depth:null}))}):t.readHoldingRegisters(e.Addr,1).then(o=>{let r=o.response._body._valuesAsArray;ejecutarconsultas(`insert into historial(Id_Parametro,Valor,Fecha) values('${e.Id}','${r}','${Fecha}');`,(e,o)=>{})}).catch(function(){console.error("INT "+require("util").inspect(arguments,{depth:null}))})})},o[0].Mysql_Time))})}})}),c.on("message",(o,n)=>{n=JSON.parse(n);let s=r.resume()._readableState.destroyed;switch(s&&r.connect(a),Fecha=moment().utcOffset("-06:00").format("YYYY-MM-DD HH:mm:ss"),o){case`${e}/WR`:""!=n.Addr&&""!=n.Valor?t.writeSingleRegister(n.Addr,n.Valor).then(function(e){console.log(e),ejecutarconsultas(`insert into historial_acciones(Nombre,Descripcion,Fecha,Topico) values('SE ESCRIBIÓ EN UN REGISTRO','SE ESCRIBIÓ EL VALOR ${n.Addr} EN LA POSICIÓN ${n.Addr}','${Fecha}','${o}');`,(e,o)=>{})}).catch(function(){console.error(arguments)}):console.log("Vació");break;case`${e}/on_off`:if(""!=n.Addr&&""!=n.Accion){console.log(n);let e=parseInt(n.Addr);"on"==n.Accion?t.writeSingleCoil(e,!0).then(r=>{ejecutarconsultas(`insert into historial_acciones(Nombre,Descripcion,Fecha,Topico) values('ENCENDIDO DE BOBINA','SE ENCENDIÓ UNA BOBINA EN LA POSITION ${e}','${Fecha}','${o}');`,(e,o)=>{})}).catch(()=>{console.error(arguments)}):"off"==n.Accion&&t.writeSingleCoil(e,!1).then(r=>{ejecutarconsultas(`insert into historial_acciones(Nombre,Descripcion,Fecha,Topico) values('APAGADO DE BOBINA','SE APAGO UNA BOBINA EN LA POSITION ${e}','${Fecha}','${o}');`,(e,o)=>{})}).catch(()=>{console.error(arguments)})}else console.log("Vació");break;case`${e}/SQL`:console.log("mensaje ",n.query),""!=n.query&&null!=n.query&&ejecutarconsultas(n.query,(r,t)=>{r||ejecutarconsultas(`insert into historial_acciones(Nombre,Descripcion,Fecha,Topico) values('COMANDOS SQL','${n.query}','${Fecha}','${o}');`,(o,r)=>{o||c.publish(`${e}/SQL/Result`,JSON.stringify(t),{qos:0,retain:!1},e=>{e||n.query.includes("UPDATE")&&setTimeout(()=>{throw"Reiniciar API por actualización de la BD"},250)})})})}}),c.on("reconnect",()=>{console.log("Reconectando al broker de CGR "),ejecutarconsultas("select*from parametros order by Tipo,Nombre asc",(e,r)=>{e?console.log("Error al consultar parámetros"):setInterval(()=>{Fecha=moment().utcOffset("-06:00").format("YYYY-MM-DD HH:mm:ss"),r.map(function(e,o){"BIT"==e.Tipo?t.readCoils(e.Addr,1).then(o=>{let r=o.response._body._valuesAsArray[0];ejecutarconsultas(`insert into historial(Id_Parametro,Valor,Fecha) values('${e.Id}','${r}','${Fecha}');`,(e,o)=>{})}).catch(function(){console.log("BIT "+require("util").inspect(arguments,{depth:null}),null)}):"FLOAT"==e.Tipo?t.readCoils(e.Addr,2).then(o=>{let r=o.response._body._valuesAsArray,t=Buffer.allocUnsafe(4);t.writeUInt16BE(r[0],2),t.writeUInt16BE(r[1],0);let a=t.readFloatBE(0);ejecutarconsultas(`insert into historial(Id_Parametro,Valor,Fecha) values('${e.Id}','${a}','${Fecha}');`,(e,o)=>{})}).catch(function(){console.error("FLOAT "+require("util").inspect(arguments,{depth:null}))}):t.readHoldingRegisters(e.Addr,1).then(o=>{let r=o.response._body._valuesAsArray;ejecutarconsultas(`insert into historial(Id_Parametro,Valor,Fecha) values('${e.Id}','${r}','${Fecha}');`,(e,o)=>{})}).catch(function(){console.error("INT "+require("util").inspect(arguments,{depth:null}))})})},o[0].Mysql_Time)})}),c.on("error",()=>{console.log("ERROR AL CONECTAR AL CONECTAR AL BROKER DE CGR ",n),ejecutarconsultas("select*from parametros order by Tipo,Nombre asc",(e,r)=>{e?console.log("Error al consultar parámetros"):setInterval(()=>{Fecha=moment().utcOffset("-06:00").format("YYYY-MM-DD HH:mm:ss"),r.map(function(e,o){"BIT"==e.Tipo?t.readCoils(e.Addr,1).then(o=>{let r=o.response._body._valuesAsArray[0];ejecutarconsultas(`insert into historial(Id_Parametro,Valor,Fecha) values('${e.Id}','${r}','${Fecha}');`,(e,o)=>{})}).catch(function(){console.log("BIT "+require("util").inspect(arguments,{depth:null}),null)}):"FLOAT"==e.Tipo?t.readCoils(e.Addr,2).then(o=>{let r=o.response._body._valuesAsArray,t=Buffer.allocUnsafe(4);t.writeUInt16BE(r[0],2),t.writeUInt16BE(r[1],0);let a=t.readFloatBE(0);ejecutarconsultas(`insert into historial(Id_Parametro,Valor,Fecha) values('${e.Id}','${a}','${Fecha}');`,(e,o)=>{})}).catch(function(){console.error("FLOAT "+require("util").inspect(arguments,{depth:null}))}):t.readHoldingRegisters(e.Addr,1).then(o=>{let r=o.response._body._valuesAsArray;ejecutarconsultas(`insert into historial(Id_Parametro,Valor,Fecha) values('${e.Id}','${r}','${Fecha}');`,(e,o)=>{})}).catch(function(){console.error("INT "+require("util").inspect(arguments,{depth:null}))})})},o[0].Mysql_Time)})}),c.on("offline",()=>{console.log("Revisa tu conexión a internet, no se puede conectar a CGR ",n),ejecutarconsultas("select*from parametros order by Tipo,Nombre asc",(e,r)=>{e?console.log("Error al consultar parámetros"):setInterval(()=>{Fecha=moment().utcOffset("-06:00").format("YYYY-MM-DD HH:mm:ss"),r.map(function(e,o){"BIT"==e.Tipo?t.readCoils(e.Addr,1).then(o=>{let r=o.response._body._valuesAsArray[0];ejecutarconsultas(`insert into historial(Id_Parametro,Valor,Fecha) values('${e.Id}','${r}','${Fecha}');`,(e,o)=>{})}).catch(function(){console.log("BIT "+require("util").inspect(arguments,{depth:null}),null)}):"FLOAT"==e.Tipo?t.readCoils(e.Addr,2).then(o=>{let r=o.response._body._valuesAsArray,t=Buffer.allocUnsafe(4);t.writeUInt16BE(r[0],2),t.writeUInt16BE(r[1],0);let a=t.readFloatBE(0);ejecutarconsultas(`insert into historial(Id_Parametro,Valor,Fecha) values('${e.Id}','${a}','${Fecha}');`,(e,o)=>{})}).catch(function(){console.error("FLOAT "+require("util").inspect(arguments,{depth:null}))}):t.readHoldingRegisters(e.Addr,1).then(o=>{let r=o.response._body._valuesAsArray;ejecutarconsultas(`insert into historial(Id_Parametro,Valor,Fecha) values('${e.Id}','${r}','${Fecha}');`,(e,o)=>{})}).catch(function(){console.error("INT "+require("util").inspect(arguments,{depth:null}))})})},o[0].Mysql_Time)})}),c.on("disconnect",()=>{console.log("desconectado a CGR ",n)});const i=`tcp://${o[0].Host_Operador_Mqtt}:${o[0].Port_Operador_Mqtt}`,u=mqtt.connect(i);u.on("connect",()=>{console.log("Conectado al broker del operador"),u.subscribe(`${o[0].Topico_Operador_Mqtt}/#`,e=>{if(e)console.log("Error al suscribirse");else{let e=r.resume()._readableState.destroyed;e&&r.connect(a),ejecutarconsultas("select*from parametros where Permisos='S' order by Tipo asc",(e,r)=>{Fecha=moment().utcOffset("-06:00").format("YYYY-MM-DD HH:mm:ss"),e?console.log("Error al consultar"):setInterval(()=>{r.map(function(e,r){"BIT"==e.Tipo?t.readCoils(e.Addr,1).then(r=>{let t=r.response._body._valuesAsArray[0],a={Ip_Publica:o[0].Ip_Publica,Ubicacion:{longitud:o[0].longitud,latitud:o[0].latitud},fecha_hora:Fecha,id_estacion:"184",nombre_estacion:o[0].Nombre_Estacion,Descripcion:e.Nombre,Valor:t};u.publish(`${o[0].Topico_Operador_Mqtt}`,JSON.stringify(a),{qos:0,retain:!1},e=>{e?console.log("Error al publicar a MQTT ORGANISMO OPERADOR".red):console.log("envió de información")})}).catch(function(){console.log("BIT "+require("util").inspect(arguments,{depth:null}),null)}):"FLOAT"==e.Tipo?t.readCoils(e.Addr,2).then(r=>{let t=r.response._body._valuesAsArray,a=Buffer.allocUnsafe(4);a.writeUInt16BE(t[0],2),a.writeUInt16BE(t[1],0);let n=a.readFloatBE(0),s={Ip_Publica:o[0].Ip_Publica,Ubicacion:{longitud:o[0].longitud,latitud:o[0].latitud},fecha_hora:Fecha,id_estacion:"184",nombre_estacion:o[0].Nombre_Estacion,Descripcion:e.Nombre,Valor:n};u.publish(`${o[0].Topico_Operador_Mqtt}`,JSON.stringify(s),{qos:0,retain:!1},e=>{e&&console.log("Error al publicar a MQTT ORGANISMO OPERADOR".red)})}).catch(function(){console.error("FLOAT "+require("util").inspect(arguments,{depth:null}))}):t.readHoldingRegisters(e.Addr,1).then(r=>{let t=r.response._body._valuesAsArray[0],a={Ip_Publica:o[0].Ip_Publica,Ubicacion:{longitud:o[0].longitud,latitud:o[0].latitud},fecha_hora:Fecha,id_estacion:"184",nombre_estacion:o[0].Nombre_Estacion,Descripcion:e.Nombre,Valor:t};u.publish(`${o[0].Topico_Operador_Mqtt}`,JSON.stringify(a)+"",{qos:0,retain:!1},e=>{e&&console.log("Error al publicar a MQTT ORGANISMO OPERADOR".red)})}).catch(function(){console.error("INT "+require("util").inspect(arguments,{depth:null}))})})},o[0].Mqtt_Time_Operador)})}})}),u.on("reconnect",()=>{console.log("Reconectando al broker operador ",i)}),u.on("error",()=>{console.log("ERROR AL CONECTAR AL BROKER OPERADOR ",i)}),u.on("offline",()=>{console.log("Revisa tu conexión a internet, no se pudo conectar al broker operador ",i)}),u.on("disconnect",()=>{console.log("desconectado del broker operador ",i)})}}),setInterval(()=>{throw"Reiniciar API ".green},3e5);