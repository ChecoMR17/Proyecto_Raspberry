function ejecutarconsultas(e,o){connection.query(e,(e,r,t)=>{e?o(e,null):o(null,r)})}const moment=require("moment"),Modbus=require("jsmodbus"),net=require("net"),colors=require("colors"),dotenv=require("dotenv"),mqtt=require("mqtt"),{log:log,Console:Console}=require("console"),{exec:exec}=require("child_process");dotenv.config();const{connection:connection}=require("./config.db");ejecutarconsultas("select*from Rasp;",(e,o)=>{if(e)console.log("Error al consultar la base de datos");else{let e=`Cgr/${o[0].Num_OT}/${o[0].Calve_Rasp}`;const r=new net.Socket,t=new Modbus.client.TCP(r),s={host:o[0].Host_Plc,port:o[0].Port_Plc};r.connect(s),r.on("connect",e=>console.log("Conectado al PLC")),r.on("error",e=>console.log(e));const n=`ws://${o[0].Host_Mqtt}:${o[0].Port_Mqtt}/mqtt`,a=`Server_${Math.floor(1e4*Math.random()+1)}`,l={clientId:a,clean:!0,keepalive:5e3,protocolVersion:5,connectTimeout:1e3,reconnectPeriod:5e3},c=mqtt.connect(n,l);c.on("connect",()=>{console.log("Conectado al broker de CGR"),c.subscribe(`${e}/#`,n=>{if(n)console.log("Error al suscribir");else{let n=r.resume()._readableState.destroyed;n&&r.connect(s),ejecutarconsultas("select*from parametros order by Tipo,Nombre asc",(r,s)=>{r?console.log("Error al consultar parámetros"):(setInterval(()=>{Fecha=moment().utcOffset("-06:00").format("YYYY-MM-DD HH:mm:ss"),s.map(function(o,r){"BIT"==o.Tipo?t.readCoils(o.Addr,1).then(r=>{let t=r.response._body._valuesAsArray[0],s={Addr:o.Addr,Nombre:o.Nombre,Tipo:o.Tipo,Valor:t+" "+o.UM,Variable:o.Variable,Descripcion:o.Descripcion};"AVISOS FALLAS"==o.Descripcion&&ejecutarconsultas(`select*from Registro_Falla where Id_Parametro='${o.Id}' order by Id desc limit 1`,(e,r)=>{e||(Object.keys(r).length>0?Number(r[0].Valor)!=Number(t)&&ejecutarconsultas(`insert into Registro_Falla(Id_Parametro,Valor,Fecha) values('${o.Id}','${t}','${Fecha}');`,(e,o)=>{}):1==t&&ejecutarconsultas(`insert into Registro_Falla(Id_Parametro,Valor,Fecha) values('${o.Id}','${t}','${Fecha}');`,(e,o)=>{}))}),c.publish(`${e}/${o.Nombre}`,JSON.stringify(s),{qos:0,retain:!1},e=>{})}).catch(function(){console.log("BIT "+require("util").inspect(arguments,{depth:null}),null)}):"FLOAT"==o.Tipo?t.readHoldingRegisters(o.Addr,2).then(r=>{let t=r.response._body._valuesAsArray,s=Buffer.allocUnsafe(4);s.writeUInt16BE(t[0],2),s.writeUInt16BE(t[1],0);let n=s.readFloatBE(0).toFixed(2),a={Addr:o.Addr,Nombre:o.Nombre,Tipo:o.Tipo+" "+o.UM,Valor:n,Variable:o.Variable,Descripcion:o.Descripcion};c.publish(`${e}/${o.Nombre}`,JSON.stringify(a),{qos:0,retain:!1},e=>{})}).catch(function(){console.error("FLOAT "+require("util").inspect(arguments,{depth:null}))}):t.readHoldingRegisters(o.Addr,1).then(r=>{let t=r.response._body._valuesAsArray[0],s={Addr:o.Addr,Nombre:o.Nombre,Tipo:o.Tipo+" "+o.UM,Valor:t,Variable:o.Variable,Descripcion:o.Descripcion};c.publish(`${e}/${o.Nombre}`,JSON.stringify(s)+"",{qos:0,retain:!1},e=>{})}).catch(function(){console.error("INT "+require("util").inspect(arguments,{depth:null}))})})},o[0].Mqtt_Time),setInterval(()=>{Fecha=moment().utcOffset("-06:00").format("YYYY-MM-DD HH:mm:ss"),s.map(function(e,o){"BIT"==e.Tipo?t.readCoils(e.Addr,1).then(o=>{let r=o.response._body._valuesAsArray[0];ejecutarconsultas(`insert into historial(Id_Parametro,Valor,Fecha) values('${e.Id}','${r}','${Fecha}');`,(e,o)=>{})}).catch(function(){console.log("BIT "+require("util").inspect(arguments,{depth:null}),null)}):"FLOAT"==e.Tipo?t.readCoils(e.Addr,2).then(o=>{let r=o.response._body._valuesAsArray,t=Buffer.allocUnsafe(4);t.writeUInt16BE(r[0],2),t.writeUInt16BE(r[1],0);let s=t.readFloatBE(0);ejecutarconsultas(`insert into historial(Id_Parametro,Valor,Fecha) values('${e.Id}','${s}','${Fecha}');`,(e,o)=>{})}).catch(function(){console.error("FLOAT "+require("util").inspect(arguments,{depth:null}))}):t.readHoldingRegisters(e.Addr,1).then(o=>{let r=o.response._body._valuesAsArray;ejecutarconsultas(`insert into historial(Id_Parametro,Valor,Fecha) values('${e.Id}','${r}','${Fecha}');`,(e,o)=>{})}).catch(function(){console.error("INT "+require("util").inspect(arguments,{depth:null}))})})},o[0].Mysql_Time))})}})}),c.on("message",(o,n)=>{n=JSON.parse(n);let a=r.resume()._readableState.destroyed;switch(a&&r.connect(s),Fecha=moment().utcOffset("-06:00").format("YYYY-MM-DD HH:mm:ss"),o){case`${e}/WR`:""!=n.Addr&&""!=n.Valor?(t.writeSingleCoil(n.Addr,n.Valor),ejecutarconsultas(`insert into historial_acciones(Nombre,Descripcion,Fecha,Topico) values('SE ESCRIBIÓ EN UN REGISTRO','SE ESCRIBIÓ EL VALOR ${n.Addr} EN LA POSICIÓN ${n.Addr}','${Fecha}','${o}');`,(e,o)=>{})):console.log("Vació");break;case`${e}/on_off`:if(""!=n.Addr&&""!=n.Accion){console.log(n);let e=parseInt(n.Addr);"on"==n.Accion?t.writeSingleCoil(e,!0).then(r=>{ejecutarconsultas(`insert into historial_acciones(Nombre,Descripcion,Fecha,Topico) values('ENCENDIDO DE BOBINA','SE ENCENDIÓ UNA BOBINA EN LA POSITION ${e}','${Fecha}','${o}');`,(e,o)=>{})}).catch(()=>{console.error(arguments)}):"off"==n.Accion&&t.writeSingleCoil(e,!1).then(r=>{ejecutarconsultas(`insert into historial_acciones(Nombre,Descripcion,Fecha,Topico) values('APAGADO DE BOBINA','SE APAGO UNA BOBINA EN LA POSITION ${e}','${Fecha}','${o}');`,(e,o)=>{})}).catch(()=>{console.error(arguments)})}else console.log("Vació");break;case`${e}/SQL`:console.log("mensaje ",n.query),""!=n.query&&null!=n.query&&ejecutarconsultas(n.query,(r,t)=>{r||ejecutarconsultas(`insert into historial_acciones(Nombre,Descripcion,Fecha,Topico) values('COMANDOS SQL','${n.query}','${Fecha}','${o}');`,(o,r)=>{o||c.publish(`${e}/SQL/Result`,JSON.stringify(t),{qos:0,retain:!1},e=>{e||setTimeout(()=>{throw"Reiniciar API por actualización de la BD"},150)})})})}}),c.on("reconnect",()=>{console.log("Reconectando a "),ejecutarconsultas("select*from parametros order by Tipo,Nombre asc",(e,r)=>{e?console.log("Error al consultar parámetros"):setInterval(()=>{Fecha=moment().utcOffset("-06:00").format("YYYY-MM-DD HH:mm:ss"),r.map(function(e,o){"BIT"==e.Tipo?t.readCoils(e.Addr,1).then(o=>{let r=o.response._body._valuesAsArray[0];ejecutarconsultas(`insert into historial(Id_Parametro,Valor,Fecha) values('${e.Id}','${r}','${Fecha}');`,(e,o)=>{})}).catch(function(){console.log("BIT "+require("util").inspect(arguments,{depth:null}),null)}):"FLOAT"==e.Tipo?t.readCoils(e.Addr,2).then(o=>{let r=o.response._body._valuesAsArray,t=Buffer.allocUnsafe(4);t.writeUInt16BE(r[0],2),t.writeUInt16BE(r[1],0);let s=t.readFloatBE(0);ejecutarconsultas(`insert into historial(Id_Parametro,Valor,Fecha) values('${e.Id}','${s}','${Fecha}');`,(e,o)=>{})}).catch(function(){console.error("FLOAT "+require("util").inspect(arguments,{depth:null}))}):t.readHoldingRegisters(e.Addr,1).then(o=>{let r=o.response._body._valuesAsArray;ejecutarconsultas(`insert into historial(Id_Parametro,Valor,Fecha) values('${e.Id}','${r}','${Fecha}');`,(e,o)=>{})}).catch(function(){console.error("INT "+require("util").inspect(arguments,{depth:null}))})})},o[0].Mysql_Time)})}),c.on("error",()=>{console.log("ERROR AL CONECTAR".red),ejecutarconsultas("select*from parametros order by Tipo,Nombre asc",(e,r)=>{e?console.log("Error al consultar parámetros"):setInterval(()=>{Fecha=moment().utcOffset("-06:00").format("YYYY-MM-DD HH:mm:ss"),r.map(function(e,o){"BIT"==e.Tipo?t.readCoils(e.Addr,1).then(o=>{let r=o.response._body._valuesAsArray[0];ejecutarconsultas(`insert into historial(Id_Parametro,Valor,Fecha) values('${e.Id}','${r}','${Fecha}');`,(e,o)=>{})}).catch(function(){console.log("BIT "+require("util").inspect(arguments,{depth:null}),null)}):"FLOAT"==e.Tipo?t.readCoils(e.Addr,2).then(o=>{let r=o.response._body._valuesAsArray,t=Buffer.allocUnsafe(4);t.writeUInt16BE(r[0],2),t.writeUInt16BE(r[1],0);let s=t.readFloatBE(0);ejecutarconsultas(`insert into historial(Id_Parametro,Valor,Fecha) values('${e.Id}','${s}','${Fecha}');`,(e,o)=>{})}).catch(function(){console.error("FLOAT "+require("util").inspect(arguments,{depth:null}))}):t.readHoldingRegisters(e.Addr,1).then(o=>{let r=o.response._body._valuesAsArray;ejecutarconsultas(`insert into historial(Id_Parametro,Valor,Fecha) values('${e.Id}','${r}','${Fecha}');`,(e,o)=>{})}).catch(function(){console.error("INT "+require("util").inspect(arguments,{depth:null}))})})},o[0].Mysql_Time)})}),c.on("offline",()=>{console.log("Revisa tu coneccion a internet".red),ejecutarconsultas("select*from parametros order by Tipo,Nombre asc",(e,r)=>{e?console.log("Error al consultar parámetros"):setInterval(()=>{Fecha=moment().utcOffset("-06:00").format("YYYY-MM-DD HH:mm:ss"),r.map(function(e,o){"BIT"==e.Tipo?t.readCoils(e.Addr,1).then(o=>{let r=o.response._body._valuesAsArray[0];ejecutarconsultas(`insert into historial(Id_Parametro,Valor,Fecha) values('${e.Id}','${r}','${Fecha}');`,(e,o)=>{})}).catch(function(){console.log("BIT "+require("util").inspect(arguments,{depth:null}),null)}):"FLOAT"==e.Tipo?t.readCoils(e.Addr,2).then(o=>{let r=o.response._body._valuesAsArray,t=Buffer.allocUnsafe(4);t.writeUInt16BE(r[0],2),t.writeUInt16BE(r[1],0);let s=t.readFloatBE(0);ejecutarconsultas(`insert into historial(Id_Parametro,Valor,Fecha) values('${e.Id}','${s}','${Fecha}');`,(e,o)=>{})}).catch(function(){console.error("FLOAT "+require("util").inspect(arguments,{depth:null}))}):t.readHoldingRegisters(e.Addr,1).then(o=>{let r=o.response._body._valuesAsArray;ejecutarconsultas(`insert into historial(Id_Parametro,Valor,Fecha) values('${e.Id}','${r}','${Fecha}');`,(e,o)=>{})}).catch(function(){console.error("INT "+require("util").inspect(arguments,{depth:null}))})})},o[0].Mysql_Time)})}),c.on("disconnect",()=>{console.log("desconectado".red)});const i="ws://broker.emqx.io:8083/mqtt",u=mqtt.connect(i);u.on("connect",()=>{console.log("Conectado al broker del operador"),u.subscribe(`${e}/#`,n=>{if(n)console.log("Error al suscrobirse");else{let n=r.resume()._readableState.destroyed;n&&r.connect(s),ejecutarconsultas("select*from parametros where Permisos='S' order by Tipo asc",(r,s)=>{r?console.log("Error al consultar"):setInterval(()=>{s.map(function(o,r){"BIT"==o.Tipo?t.readCoils(o.Addr,1).then(r=>{let t=r.response._body._valuesAsArray[0],s={Nombre:o.Nombre,Tipo:o.Tipo,Valor:t};u.publish(`${e}/${o.Nombre}`,JSON.stringify(s),{qos:0,retain:!1},e=>{e&&console.log("Error al publicar a MQTT ORGANISMO OPERADOR".red)})}).catch(function(){console.log("BIT "+require("util").inspect(arguments,{depth:null}),null)}):"FLOAT"==o.Tipo?t.readCoils(o.Addr,2).then(r=>{let t=r.response._body._valuesAsArray,s=Buffer.allocUnsafe(4);s.writeUInt16BE(t[0],2),s.writeUInt16BE(t[1],0);let n=s.readFloatBE(0),a={Nombre:o.Nombre,Tipo:o.Tipo,Valor:n};u.publish(`${e}/${o.Nombre}`,JSON.stringify(a),{qos:0,retain:!1},e=>{e&&console.log("Error al publicar a MQTT ORGANISMO OPERADOR".red)})}).catch(function(){console.error("FLOAT "+require("util").inspect(arguments,{depth:null}))}):t.readHoldingRegisters(o.Addr,1).then(r=>{let t=r.response._body._valuesAsArray[0],s={Nombre:o.Nombre,Tipo:o.Tipo,Valor:t};u.publish(`${e}/${o.Nombre}`,JSON.stringify(s)+"",{qos:0,retain:!1},e=>{e&&console.log("Error al publicar a MQTT ORGANISMO OPERADOR".red)})}).catch(function(){console.error("INT "+require("util").inspect(arguments,{depth:null}))})})},o[0].Mqtt_Time)})}})}),u.on("reconnect",()=>{console.log("Reconectando a ")}),u.on("error",()=>{console.log("ERROR AL CONECTAR".red)}),u.on("offline",()=>{console.log("Revisa tu coneccion a internet".red)}),u.on("disconnect",()=>{console.log("desconectado".red)})}}),setInterval(()=>{throw"Reiniciar API para recolección ".green},3e5);